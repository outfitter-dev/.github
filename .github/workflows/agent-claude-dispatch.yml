# IMPORTANT: Do not move this file in your repo! Make sure it's located at .github/workflows/claude-dispatch.yml
name: Claude Code Dispatch

# IMPORTANT: Do not modify this `on` section!
on:
  repository_dispatch:
    types: [claude-dispatch]

jobs:
  claude-dispatch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # - name: Preliminary Setup
      # run: |
      # echo "Setting up environment..."
      # Add any preliminary setup commands here to setup Claude's dev environment
      # e.g., npm install, etc.

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@eap
        with:
          mode: 'remote-agent'

          # Optional: Specify an API key, otherwise we'll use your Claude account automatically
          # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # MCP configuration
          mcp_config: |
            {
              "mcpServers": {
                "sequential-thinking": {
                  "command": "npx",
                  "args": [
                    "-y",
                    "@modelcontextprotocol/server-sequential-thinking"
                  ]
                }
              }
            }

          # Allow additioanl domains
          experimental_allowed_domains: |
            .anthropic.com
            .github.com
            .githubusercontent.com
            ghcr.io
            .blob.core.windows.net

          # Optional: Allow Claude to run specific commands
          # Allow Claude to run specific commands
          allowed_tools: |
            Edit,Read,Write,Bash
            mcp__sequential-thinking__sequentialthinking

          # Provide Claude with custom instructions
          custom_instructions: |
            You have also been granted tools for editing files and running bun commands (install, run, test, typecheck, format, lint, sandbox, pre*) for testing your changes.
            You also have access to `mcp__sequential-thinking__sequentialthinking` to work out more complex problems. Use it to think longer.
            Use Bun to the fullest extent
            Don't .gitignore `.agent/` or `path/to/rules` if they're not compiled with Rulesets
